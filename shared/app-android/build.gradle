apply plugin: 'com.android.application'

Properties projectNameProperties = new Properties()
projectNameProperties.load(new FileInputStream(file("project_name.properties")))

def projectName = projectNameProperties["project.name"]
println "App project name: " + projectName

if (projectName == "MT") {
    apply plugin: 'io.fabric'
    apply plugin: "org.sonarqube"
}

dependencies {
    if (projectName == "MT") {
        // ALL
        implementation(project(':commons-android')) {
            exclude group: 'com.google.protobuf', module: 'protobuf-java'
        }
        implementation rootProject.ext.supportLibs.appCompat
        implementation rootProject.ext.supportLibs.activity
        implementation rootProject.ext.supportLibs.fragment
        implementation rootProject.ext.supportLibs.customTabs
        implementation rootProject.ext.supportLibs.design
        implementation rootProject.ext.gpsLibs.basement // from commons-android
        implementation rootProject.ext.gpsLibs.location
        implementation rootProject.ext.gpsLibs.maps
        implementation rootProject.ext.gpsLibs.firebase_ads
        implementation rootProject.ext.gpsLibs.firebase_analytics
        implementation rootProject.ext.gpsLibs.firebase_core
        implementation(rootProject.ext.gpsLibs.firebase_crashlytics_aar) {
            transitive = true
        }
        implementation rootProject.ext.fbLibs.audienceNetwork
        implementation rootProject.ext.fbLibs.audienceNetworkMediation
        // DEBUG
        debugImplementation rootProject.ext.squareLibs.leakcanary
        debugImplementation rootProject.ext.squareLibs.leakcanary_support_fragment
        // RELEASE
        releaseImplementation rootProject.ext.squareLibs.leakcanary_no_op
        // TEST
        testImplementation rootProject.ext.squareLibs.leakcanary_no_op
        // DEBUG
        debugImplementation 'androidx.multidex:multidex:2.0.1'

        testImplementation rootProject.ext.jUnitLibs.jUnit
        testImplementation rootProject.ext.mockitoLibs.mockitoCore
    } else {
        implementation project(':commons-android')
    }
}

android {
    compileSdkVersion rootProject.ext.compileSdkVersion

    compileOptions {
        sourceCompatibility rootProject.javaVersion
        targetCompatibility rootProject.javaVersion
    }

    Properties versionProperties = new Properties()
    versionProperties.load(new FileInputStream(file("../commons-android/version.properties")))
    def theVersionName=versionProperties['version.name']
    println "App version name: " + theVersionName

    def commitCountLocal = "git rev-list HEAD --count".execute().text.trim().toInteger()

    def commitCountS = "git -C ../ rev-list HEAD --count".execute().text.trim()
    if(commitCountS.empty) {
        commitCountS = "1"
    }
    def commitCount = commitCountS.toInteger()
    def theVersionCode=1000+commitCount
    println "App version code: " + theVersionCode

    def useGooglePlayUploadKeysProperties = true
    println "Using Google Play Upload keys: " + useGooglePlayUploadKeysProperties

    Properties appSigningKeysProperties = new Properties()
    def appSigningKeysPropertiesFile = file("app-signing-release-keys.properties")
    if (appSigningKeysPropertiesFile.exists()) {
        appSigningKeysProperties.load(new FileInputStream(appSigningKeysPropertiesFile))
    } else {
        appSigningKeysPropertiesFile = file("../app-signing-release-keys.properties")
        if (appSigningKeysPropertiesFile.exists()) {
            appSigningKeysProperties.load(new FileInputStream(appSigningKeysPropertiesFile))
        }
    }

    Properties googlePlayUploadKeysProperties = new Properties()
    def googlePlayUploadKeysPropertiesFile = file("google-play-upload-keys.properties")
    if (googlePlayUploadKeysPropertiesFile.exists()) {
        googlePlayUploadKeysProperties.load(new FileInputStream(googlePlayUploadKeysPropertiesFile))
    } else {
        googlePlayUploadKeysPropertiesFile = file("../google-play-upload-keys.properties")
        if (googlePlayUploadKeysPropertiesFile.exists()) {
            googlePlayUploadKeysProperties.load(new FileInputStream(googlePlayUploadKeysPropertiesFile))
        }
    }

    def resValueFr = file("res/values-fr")

    defaultConfig {
        versionCode theVersionCode
        versionName theVersionName+"r"+theVersionCode
        if (useGooglePlayUploadKeysProperties) {
            setProperty("archivesBaseName", "${projectName}_v${theVersionName}_r${theVersionCode}_upload")
        } else {
            setProperty("archivesBaseName", "${projectName}_v${theVersionName}_r${theVersionCode}")
        }
        if (resValueFr.exists()) {
            resConfigs "en", "fr"
        } else {
            resConfigs "en"
        }
        minSdkVersion rootProject.ext.minSdkVersion
        // minSdkVersion 21 // DEBUG avoid using legacy multidex
        targetSdkVersion rootProject.ext.targetSdkVersion
    }

    signingConfigs {
        release {
            if (useGooglePlayUploadKeysProperties) {
                if (googlePlayUploadKeysPropertiesFile.exists()) {
                    storeFile file(googlePlayUploadKeysProperties['key.store'])
                    storePassword googlePlayUploadKeysProperties['key.store.password']
                    keyAlias googlePlayUploadKeysProperties['key.alias']
                    keyPassword googlePlayUploadKeysProperties['key.alias.password']
                }
            } else {
                if (appSigningKeysPropertiesFile.exists()) {
                    storeFile file(appSigningKeysProperties['key.store'])
                    storePassword appSigningKeysProperties['key.store.password']
                    keyAlias appSigningKeysProperties['key.alias']
                    keyPassword appSigningKeysProperties['key.alias.password']
                }
            }
        }
    }

    buildTypes {
        debug {
            versionNameSuffix "_DEBUG"

            // testCoverageEnabled false // DEBUG skip coverage report
            shrinkResources false
            if (projectName == "MT") {
                minifyEnabled true
                proguardFiles getDefaultProguardFile('proguard-android.txt'),
                        'proguard-rules.pro'
                multiDexEnabled true
                // Disable fabric build ID generation for debug builds
                ext.enableCrashlytics = false
                // https://docs.fabric.io/android/crashlytics/build-tools.html
                ext.alwaysUpdatedBuildId = false
            } else {
                minifyEnabled false
            }
            aaptOptions.cruncherEnabled = false
        }
        //noinspection GroovyMissingReturnStatement
        release {
            if (useGooglePlayUploadKeysProperties) {
                if (googlePlayUploadKeysPropertiesFile.exists()) {
                    signingConfig signingConfigs.release
                }
            } else {
                if (appSigningKeysPropertiesFile.exists()) {
                    signingConfig signingConfigs.release
                }
            }

            if (projectName == "MT") {
                shrinkResources true
                minifyEnabled true
                proguardFiles getDefaultProguardFile('proguard-android.txt'),
                        'proguard-rules.pro'
            } else {
                 shrinkResources false
                    minifyEnabled false
            }
        }
    }

    //noinspection GroovyMissingReturnStatement
    lintOptions {
        if (projectName == "MT") {
            abortOnError true
            warningsAsErrors false
            ignoreWarnings false
            quiet false
        } else {
            abortOnError false
        }
        checkDependencies true // also check leaf modules
        // checkAllWarnings true // too slow for CI, can be enabled locally
        ignoreTestSources true
        if (projectName == "MT") {
            warning 'InvalidPackage', //
                    'ClickableViewAccessibility', //
                    'MergeRootFrame', //
                    'Overdraw', //
                    'UselessParent', //
                    'IconDensities',  //
                    'RtlHardcoded'
        }
    }

    sourceSets {
        main {
            manifest.srcFile 'AndroidManifest.xml'
            java.srcDirs = ['src']
            resources.srcDirs = ['src']
            aidl.srcDirs = ['src']
            renderscript.srcDirs = ['src']
            res.srcDirs = ['res']
            if (projectName == "MT") {
                // NOTHING
            } else {
                res.srcDirs += 'res-current'
                res.srcDirs += 'res-next'
            }
            assets.srcDirs = ['assets']
        }
        if (projectName == "MT") {
            debug {
                java.srcDirs = ['srcDebug']
                resources.srcDirs = ['srcDebug']
                res.srcDirs = ['resDebug']
            }
        }
        test {
            java.srcDirs = ['srcTest']
            resources.srcDirs = ['srcTest']
        }
        androidTest {
            java.srcDirs = ['srcAndroidTest']
            resources.srcDirs = ['srcAndroidTest']
        }
    }

    testOptions {
        unitTests {
            includeAndroidResources = true
            returnDefaultValues = true
            all {
                jvmArgs '-noverify'
                testLogging {
                    events 'passed', 'skipped', 'failed'
                }
            }
        }
    }
}

if (projectName == "MT") {
    apply plugin: 'com.google.gms.google-services'
}
